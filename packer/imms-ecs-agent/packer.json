{
    "variables": {
        "name": "imms-ecs-agent",
        "long_name": "imms-ecs-agent-packer-build-{{ timestamp }}",
        "region": "eu-west-2",
        "instance_type": "t3a.small",
        "password": "{{ aws_secretsmanager `imms_ops_root_pass` }}"
    },
    "builders": [
        {
            "type": "amazon-ebs",
            "profile": "{{ user `aws_profile` }}",
            "ami_name": "{{ user `long_name` }}",
            "ami_regions": [
                "eu-west-2"
            ],
            "ami_users": "{{ user `ami_share_account_ids` }}",
            "kms_key_id": "{{ user `ami_share_kms_key` }}",
            "instance_type": "{{ user `instance_type` }}",
            "region": "{{ user `region` }}",
            "subnet_filter": {
                "filters": {
                    "tag:Name": "public-a"
                },
                "most_free": true,
                "random": false
            },
            "associate_public_ip_address": "true",
            "encrypt_boot": "true",
            "iam_instance_profile": "{{ user `iam_instance_profile` }}",
            "ssh_username": "ubuntu",
            "ssh_pty": "false",
            "ssh_interface": "{{ user `ssh_interface` }}",
            "temporary_security_group_source_cidrs": "{{ user `temporary_source_cidr` }}",
            "source_ami_filter": {
                "filters": {
                    "virtualization-type": "hvm",
                    "name": "ubuntu-base*",
                    "root-device-type": "ebs"
                },
                "owners": [
                    "self"
                ],
                "most_recent": true
            },
            "launch_block_device_mappings": [
                {
                    "device_name": "/dev/sda1",
                    "volume_size": 10,
                    "volume_type": "gp2",
                    "delete_on_termination": true
                }
            ],
            "snapshot_tags": {
                "Name": "{{ user `long_name` }}",
                "source": "packer"
            },
            "run_tags": {
                "Name": "{{ user `long_name` }}",
                "source": "packer"
            },
            "tags": {
                "Name": "{{ user `name` }}",
                "source": "packer"
            },
            "access_key": "{{ user `access_key` }}",
            "secret_key": "{{ user `secret_key` }}"
        }
    ],
    "provisioners": [
        {
            "type": "shell",
            "inline": [
                "while [ ! -f /var/lib/cloud/instance/boot-finished ]; do echo 'Waiting for cloud-init...'; sleep 1; done"
            ]
        },
        {
            "type": "file",
            "source": "files",
            "destination": "/tmp/files"
        },
        {
            "type": "file",
            "source": "../_shared/files",
            "destination": "/tmp/files/shared"
        },
        {
            "type": "shell",
            "inline": [
                "sudo sh -c \"echo 'net.ipv4.conf.all.route_localnet = 1' >> /etc/sysctl.conf\"",
                "sudo sh -c \"echo 'net.ipv4.ip_forward = 0' >> /etc/sysctl.conf\"",
                "sudo sysctl -p /etc/sysctl.conf",
                "echo iptables-persistent iptables-persistent/autosave_v4 boolean true | sudo debconf-set-selections",
                "echo iptables-persistent iptables-persistent/autosave_v6 boolean true | sudo debconf-set-selections",
                "sudo apt-get install -y iptables-persistent",
                "sudo iptables -t nat -A PREROUTING -p tcp -d 169.254.170.2 --dport 80 -j DNAT --to-destination 127.0.0.1:51679",
                "sudo iptables -t nat -A OUTPUT -d 169.254.170.2 -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 51679",
                "sudo sh -c 'iptables-save > /etc/iptables/rules.v4'",
                "sudo mkdir -p /etc/ecs",
                "sudo mv /tmp/files/ecs.config /etc/ecs"
            ]
        },
        {
            "type": "shell",
            "inline": [
                "echo 'root:{{ user `password` }}' | sudo chpasswd",
                "sudo chown 0:0 /tmp/files/sudoers/imms-users",
                "sudo mv /tmp/files/sudoers/imms-users /etc/sudoers.d/z_imms-users",
                "echo '{{user `password` }}' | sudo -S true",
                "sudo find /etc/sudoers.d -type f -not -name README -not -name z_imms-users -delete"
            ]
        }
    ]
}