import boto3
import pandas as pd
import io

def lambda_handler(event, context):
    # Initialize S3 client
    s3 = boto3.client('s3')
    
    # Source and destination bucket names
    source_bucket = 'local-immunisation-mesh'
    destination_bucket = 'local-immunisation-mesh-s3logs'
    
    # File names
    dat_file_key = 's3://local-immunisation-mesh/inbound/X26OT303/'
    csv_file_key = 's3://local-immunisation-mesh-s3logs/AWSLogs/'
    #xlsx_file_key = 'path/to/your/file.xlsx'
    
    # Read the .dat file from S3
    dat_obj = s3.get_object(Bucket=source_bucket, Key=dat_file_key)
    dat_content = dat_obj['Body'].read().decode('utf-8')
    
    # Convert .dat content to DataFrame
    data = pd.read_csv(io.StringIO(dat_content), delimiter='\t', header=None)
    
    # Convert DataFrame to CSV
    csv_buffer = io.StringIO()
    data.to_csv(csv_buffer, index=False)
    
    # Upload CSV to S3
    s3.put_object(Bucket=destination_bucket, Key=csv_file_key, Body=csv_buffer.getvalue())
    
    # # Convert DataFrame to XLSX
    # xlsx_buffer = io.BytesIO()
    # with pd.ExcelWriter(xlsx_buffer, engine='xlsxwriter') as writer:
    #     data.to_excel(writer, index=False)
    
    # # Upload XLSX to S3
    # s3.put_object(Bucket=destination_bucket, Key=xlsx_file_key, Body=xlsx_buffer.getvalue())
    
    return {
        'statusCode': 200,
        'body': 'Files converted and uploaded successfully!'
    }
