token started.......
✅ Pipe-delimited file saved to: /home/runner/work/immunisation-fhir-api/immunisation-fhir-api/tests/e2e_automation/batch_files_directory/HPV_Vaccinations_v5_YGA_20260212T16152100.csv
Batch file created: HPV_Vaccinations_v5_YGA_20260212T16152100.csv
Upload successful: HPV_Vaccinations_v5_YGA_20260212T16152100.csv → immunisation-batch-internal-qa-data-sources
Batch file uploaded to S3: HPV_Vaccinations_v5_YGA_20260212T16152100.csv
Waiting for file in archive: s3://immunisation-batch-internal-qa-data-sources/archive/HPV_Vaccinations_v5_YGA_20260212T16152100.csv
Still waiting... (0s)
Still waiting... (5s)
Still waiting... (10s)
Still waiting... (15s)
Still waiting... (20s)
Still waiting... (25s)
Still waiting... (30s)
Still waiting... (35s)
Still waiting... (40s)
File found in archive: archive/HPV_Vaccinations_v5_YGA_20260212T16152100.csv
Waiting for ACK files starting with 'ack/HPV_Vaccinations_v5_YGA_20260212T16152100' in bucket: immunisation-batch-internal-qa-data-destinations
[MODE] Expecting ONLY CSV ACK file
[FOUND] .csv file located: ack/HPV_Vaccinations_v5_YGA_20260212T16152100_InfAck_20260212T16152200.csv
[SUCCESS] Loaded .csv file (299 bytes)
[COMPLETE] All expected ACK files received
Waiting for ACK files starting with 'forwardedFile/HPV_Vaccinations_v5_YGA_20260212T16152100' in bucket: immunisation-batch-internal-qa-data-destinations
[MODE] Expecting BOTH CSV and JSON ACK files
[FOUND] .csv file located: forwardedFile/HPV_Vaccinations_v5_YGA_20260212T16152100_BusAck_20260212T16152200.csv
[SUCCESS] Loaded .csv file (208 bytes)
[FOUND] .json file located: forwardedFile/HPV_Vaccinations_v5_YGA_20260212T16152100_BusAck_20260212T16152200.json
[SUCCESS] Loaded .json file (434 bytes)
[COMPLETE] All expected ACK files received
No rows found in BUS ACK file for successful records
Attempt 1: Found 1 items

Found Audit detail for filename=HPV_Vaccinations_v5_YGA_20260212T16152100.csv


 Imms Event response is {'Items': [{'Version': Decimal('1'), 'IdentifierPK': 'https://fhir.nhs.uk/Id/Automation-vaccine-administered-event-uk#Valid_NhsNumber-20260212T161521', 'Operation': 'CREATE', 'SupplierSystem': 'TPP', 'PatientPK': 'Patient#9692958450', 'Resource': '{"resourceType": "Immunization", "status": "completed", "protocolApplied": [{"targetDisease": [{"coding": [{"system": "http://snomed.info/sct", "code": "240532009", "display": "Human papilloma virus infection"}]}], "doseNumberPositiveInt": 1}], "reasonCode": [{"coding": [{"system": "http://snomed.info/sct", "code": "443684005"}]}], "recorded": "2026-02-12", "identifier": [{"value": "Valid_NhsNumber-20260212T161521", "system": "https://fhir.nhs.uk/Id/Automation-vaccine-administered-event-uk"}], "patient": {"reference": "#Patient1"}, "contained": [{"id": "Patient1", "resourceType": "Patient", "birthDate": "2000-07-25", "gender": "male", "address": [{"postalCode": "NR34 7BH"}], "identifier": [{"system": "https://fhir.nhs.uk/Id/nhs-number", "value": "9692958450"}], "name": [{"family": "WARREN", "given": ["TOBIN"]}]}, {"resourceType": "Practitioner", "id": "Practitioner1", "name": [{"family": "Tests", "given": ["Automation"]}]}], "vaccineCode": {"coding": [{"system": "http://snomed.info/sct", "code": "33493111000001108", "display": "Gardasil 9 vaccine suspension for injection 0.5ml pre-filled syringes (Merck Sharp & Dohme (UK) Ltd) (product)"}]}, "manufacturer": {"display": "Merck Sharp & Dohme (UK) Ltd"}, "expirationDate": "2026-02-12", "lotNumber": "633741", "extension": [{"url": "https://fhir.hl7.org.uk/StructureDefinition/Extension-UKCore-VaccinationProcedure", "valueCodeableConcept": {"coding": [{"system": "http://snomed.info/sct", "code": "761841000", "display": "Administration of vaccine product containing only Human papillomavirus antigen (procedure)"}]}}], "occurrenceDateTime": "2026-02-12T16:14:31+00:00", "primarySource": true, "site": {"coding": [{"system": "http://snomed.info/sct", "code": "368208006", "display": "Left upper arm structure"}]}, "route": {"coding": [{"system": "http://snomed.info/sct", "code": "78421000", "display": "Intramuscular"}]}, "doseQuantity": {"value": 0.5, "unit": "millilitre", "system": "http://snomed.info/sct", "code": "ml"}, "performer": [{"actor": {"type": "Organization", "identifier": {"system": "https://fhir.nhs.uk/Id/ods-organization-code", "value": "X99999"}}}, {"actor": {"reference": "#Practitioner1"}}], "location": {"identifier": {"value": "X99999", "system": "https://fhir.nhs.uk/Id/ods-organization-code"}}, "id": "c4db7f0f-5770-4936-8d2f-71dc09b32553"}', 'PK': 'Immunization#c4db7f0f-5770-4936-8d2f-71dc09b32553', 'PatientSK': 'HPV#c4db7f0f-5770-4936-8d2f-71dc09b32553'}], 'Count': 1, 'ScannedCount': 1, 'ResponseMetadata': {'RequestId': '7F7D753BJ73VPTTUA3S27J8J83VV4KQNSO5AEMVJF66Q9ASUAAJG', 'HTTPStatusCode': 200, 'HTTPHeaders': {'server': 'Server', 'date': 'Thu, 12 Feb 2026 16:16:09 GMT', 'content-type': 'application/x-amz-json-1.0', 'content-length': '3021', 'connection': 'keep-alive', 'x-amzn-requestid': '7F7D753BJ73VPTTUA3S27J8J83VV4KQNSO5AEMVJF66Q9ASUAAJG', 'x-amz-crc32': '632744647'}, 'RetryAttempts': 0}} 


 Imms Event response is {'Items': [{'Operation': 'CREATE', 'PK': 'Immunization#3d9a6a73-f9ec-4b2e-93c2-e250e1d29489', 'Resource': '{"resourceType": "Immunization", "status": "completed", "protocolApplied": [{"targetDisease": [{"coding": [{"system": "http://snomed.info/sct", "code": "240532009", "display": "Human papilloma virus infection"}]}], "doseNumberPositiveInt": 1}], "reasonCode": [{"coding": [{"system": "http://snomed.info/sct", "code": "443684005"}]}], "recorded": "2026-02-12", "identifier": [{"value": "InvalidInPDS_NhsNumber-20260212T161521", "system": "https://fhir.nhs.uk/Id/Automation-vaccine-administered-event-uk"}], "patient": {"reference": "#Patient1"}, "contained": [{"id": "Patient1", "resourceType": "Patient", "birthDate": "1980-11-01", "gender": "unknown", "address": [{"postalCode": "LS01 1AB"}], "identifier": [{"system": "https://fhir.nhs.uk/Id/nhs-number", "value": "9449310599"}], "name": [{"family": "test1", "given": ["test2"]}]}, {"resourceType": "Practitioner", "id": "Practitioner1", "name": [{"family": "Tests", "given": ["Automation"]}]}], "vaccineCode": {"coding": [{"system": "http://snomed.info/sct", "code": "33493111000001108", "display": "Gardasil 9 vaccine suspension for injection 0.5ml pre-filled syringes (Merck Sharp & Dohme (UK) Ltd) (product)"}]}, "manufacturer": {"display": "Merck Sharp & Dohme (UK) Ltd"}, "expirationDate": "2026-02-12", "lotNumber": "294636", "extension": [{"url": "https://fhir.hl7.org.uk/StructureDefinition/Extension-UKCore-VaccinationProcedure", "valueCodeableConcept": {"coding": [{"system": "http://snomed.info/sct", "code": "761841000", "display": "Administration of vaccine product containing only Human papillomavirus antigen (procedure)"}]}}], "occurrenceDateTime": "2026-02-12T16:14:31+00:00", "primarySource": true, "site": {"coding": [{"system": "http://snomed.info/sct", "code": "368208006", "display": "Left upper arm structure"}]}, "route": {"coding": [{"system": "http://snomed.info/sct", "code": "34206005", "display": "Subcutaneous route (qualifier value)"}]}, "doseQuantity": {"value": 0.5, "unit": "millilitre", "system": "http://snomed.info/sct", "code": "ml"}, "performer": [{"actor": {"type": "Organization", "identifier": {"system": "https://fhir.nhs.uk/Id/ods-organization-code", "value": "X99999"}}}, {"actor": {"reference": "#Practitioner1"}}], "location": {"identifier": {"value": "X99999", "system": "https://fhir.nhs.uk/Id/ods-organization-code"}}, "id": "3d9a6a73-f9ec-4b2e-93c2-e250e1d29489"}', 'PatientSK': 'HPV#3d9a6a73-f9ec-4b2e-93c2-e250e1d29489', 'SupplierSystem': 'TPP', 'PatientPK': 'Patient#9449310599', 'Version': Decimal('1'), 'IdentifierPK': 'https://fhir.nhs.uk/Id/Automation-vaccine-administered-event-uk#InvalidInPDS_NhsNumber-20260212T161521'}], 'Count': 1, 'ScannedCount': 1, 'ResponseMetadata': {'RequestId': '7GAV80HMOF5QJV7HKR39JG74L7VV4KQNSO5AEMVJF66Q9ASUAAJG', 'HTTPStatusCode': 200, 'HTTPHeaders': {'server': 'Server', 'date': 'Thu, 12 Feb 2026 16:16:10 GMT', 'content-type': 'application/x-amz-json-1.0', 'content-length': '3060', 'connection': 'keep-alive', 'x-amzn-requestid': '7GAV80HMOF5QJV7HKR39JG74L7VV4KQNSO5AEMVJF66Q9ASUAAJG', 'x-amz-crc32': '991946800'}, 'RetryAttempts': 0}} 


 Imms Event response is {'Items': [{'Version': Decimal('1'), 'PatientSK': 'HPV#1f900386-5f4f-4984-825f-4943220146fc', 'PK': 'Immunization#1f900386-5f4f-4984-825f-4943220146fc', 'Operation': 'CREATE', 'PatientPK': 'Patient#9449310475', 'SupplierSystem': 'TPP', 'Resource': '{"resourceType": "Immunization", "status": "completed", "protocolApplied": [{"targetDisease": [{"coding": [{"system": "http://snomed.info/sct", "code": "240532009", "display": "Human papilloma virus infection"}]}], "doseNumberPositiveInt": 1}], "reasonCode": [{"coding": [{"system": "http://snomed.info/sct", "code": "443684005"}]}], "recorded": "2026-02-12", "identifier": [{"value": "SFlag_NhsNumber-20260212T161521", "system": "https://fhir.nhs.uk/Id/Automation-vaccine-administered-event-uk"}], "patient": {"reference": "#Patient1"}, "contained": [{"id": "Patient1", "resourceType": "Patient", "birthDate": "1980-11-01", "gender": "unknown", "address": [{"postalCode": "LS01 1AB"}], "identifier": [{"system": "https://fhir.nhs.uk/Id/nhs-number", "value": "9449310475"}], "name": [{"family": "test1", "given": ["test2"]}]}, {"resourceType": "Practitioner", "id": "Practitioner1", "name": [{"family": "Tests", "given": ["Automation"]}]}], "vaccineCode": {"coding": [{"system": "http://snomed.info/sct", "code": "33493111000001108", "display": "Gardasil 9 vaccine suspension for injection 0.5ml pre-filled syringes (Merck Sharp & Dohme (UK) Ltd) (product)"}]}, "manufacturer": {"display": "Merck Sharp & Dohme (UK) Ltd"}, "expirationDate": "2026-02-12", "lotNumber": "640145", "extension": [{"url": "https://fhir.hl7.org.uk/StructureDefinition/Extension-UKCore-VaccinationProcedure", "valueCodeableConcept": {"coding": [{"system": "http://snomed.info/sct", "code": "761841000", "display": "Administration of vaccine product containing only Human papillomavirus antigen (procedure)"}]}}], "occurrenceDateTime": "2026-02-12T16:14:31+00:00", "primarySource": true, "site": {"coding": [{"system": "http://snomed.info/sct", "code": "368208006", "display": "Left upper arm structure"}]}, "route": {"coding": [{"system": "http://snomed.info/sct", "code": "78421000", "display": "Intramuscular"}]}, "doseQuantity": {"value": 0.5, "unit": "millilitre", "system": "http://snomed.info/sct", "code": "ml"}, "performer": [{"actor": {"type": "Organization", "identifier": {"system": "https://fhir.nhs.uk/Id/ods-organization-code", "value": "X99999"}}}, {"actor": {"reference": "#Practitioner1"}}], "location": {"identifier": {"value": "X99999", "system": "https://fhir.nhs.uk/Id/ods-organization-code"}}, "id": "1f900386-5f4f-4984-825f-4943220146fc"}', 'IdentifierPK': 'https://fhir.nhs.uk/Id/Automation-vaccine-administered-event-uk#SFlag_NhsNumber-20260212T161521'}], 'Count': 1, 'ScannedCount': 1, 'ResponseMetadata': {'RequestId': 'QQHOJ1U480B4A0AIV2DIRRLGO3VV4KQNSO5AEMVJF66Q9ASUAAJG', 'HTTPStatusCode': 200, 'HTTPHeaders': {'server': 'Server', 'date': 'Thu, 12 Feb 2026 16:16:10 GMT', 'content-type': 'application/x-amz-json-1.0', 'content-length': '3023', 'connection': 'keep-alive', 'x-amzn-requestid': 'QQHOJ1U480B4A0AIV2DIRRLGO3VV4KQNSO5AEMVJF66Q9ASUAAJG', 'x-amz-crc32': '2041296748'}, 'RetryAttempts': 0}} 


 Imms Event response is {'Items': [{'Version': Decimal('1'), 'PatientPK': 'Patient#3510670485', 'Operation': 'CREATE', 'SupplierSystem': 'TPP', 'Resource': '{"resourceType": "Immunization", "status": "completed", "protocolApplied": [{"targetDisease": [{"coding": [{"system": "http://snomed.info/sct", "code": "240532009", "display": "Human papilloma virus infection"}]}], "doseNumberPositiveInt": 1}], "reasonCode": [{"coding": [{"system": "http://snomed.info/sct", "code": "443684005"}]}], "recorded": "2026-02-12", "identifier": [{"value": "Mod11_NhSNumber-20260212T161521", "system": "https://fhir.nhs.uk/Id/Automation-vaccine-administered-event-uk"}], "patient": {"reference": "#Patient1"}, "contained": [{"id": "Patient1", "resourceType": "Patient", "birthDate": "2007-11-25", "gender": "unknown", "address": [{"postalCode": "LS8 4HS"}], "identifier": [{"system": "https://fhir.nhs.uk/Id/nhs-number", "value": "3510670485"}], "name": [{"family": "STERLING", "given": ["Sall"]}]}, {"resourceType": "Practitioner", "id": "Practitioner1", "name": [{"family": "Tests", "given": ["Automation"]}]}], "vaccineCode": {"coding": [{"system": "http://snomed.info/sct", "code": "33493111000001108", "display": "Gardasil 9 vaccine suspension for injection 0.5ml pre-filled syringes (Merck Sharp & Dohme (UK) Ltd) (product)"}]}, "manufacturer": {"display": "Merck Sharp & Dohme (UK) Ltd"}, "expirationDate": "2026-02-12", "lotNumber": "320738", "extension": [{"url": "https://fhir.hl7.org.uk/StructureDefinition/Extension-UKCore-VaccinationProcedure", "valueCodeableConcept": {"coding": [{"system": "http://snomed.info/sct", "code": "761841000", "display": "Administration of vaccine product containing only Human papillomavirus antigen (procedure)"}]}}], "occurrenceDateTime": "2026-02-12T16:14:31+00:00", "primarySource": true, "site": {"coding": [{"system": "http://snomed.info/sct", "code": "368209003", "display": "Right upper arm structure"}]}, "route": {"coding": [{"system": "http://snomed.info/sct", "code": "78421000", "display": "Intramuscular"}]}, "doseQuantity": {"value": 0.5, "unit": "millilitre", "system": "http://snomed.info/sct", "code": "ml"}, "performer": [{"actor": {"type": "Organization", "identifier": {"system": "https://fhir.nhs.uk/Id/ods-organization-code", "value": "X99999"}}}, {"actor": {"reference": "#Practitioner1"}}], "location": {"identifier": {"value": "X99999", "system": "https://fhir.nhs.uk/Id/ods-organization-code"}}, "id": "3445b9d5-bcc4-44a3-b3bd-1408c0e65f48"}', 'IdentifierPK': 'https://fhir.nhs.uk/Id/Automation-vaccine-administered-event-uk#Mod11_NhSNumber-20260212T161521', 'PatientSK': 'HPV#3445b9d5-bcc4-44a3-b3bd-1408c0e65f48', 'PK': 'Immunization#3445b9d5-bcc4-44a3-b3bd-1408c0e65f48'}], 'Count': 1, 'ScannedCount': 1, 'ResponseMetadata': {'RequestId': 'UAB3NRGPGCA7H4UPB5ERVBKP3RVV4KQNSO5AEMVJF66Q9ASUAAJG', 'HTTPStatusCode': 200, 'HTTPHeaders': {'server': 'Server', 'date': 'Thu, 12 Feb 2026 16:16:10 GMT', 'content-type': 'application/x-amz-json-1.0', 'content-length': '3025', 'connection': 'keep-alive', 'x-amzn-requestid': 'UAB3NRGPGCA7H4UPB5ERVBKP3RVV4KQNSO5AEMVJF66Q9ASUAAJG', 'x-amz-crc32': '3600414178'}, 'RetryAttempts': 0}} 


 Imms Event response is {'Items': [{'Operation': 'CREATE', 'SupplierSystem': 'TPP', 'PK': 'Immunization#800be473-9a1a-4dbd-9fb6-3381d17c5e9b', 'PatientSK': 'HPV#800be473-9a1a-4dbd-9fb6-3381d17c5e9b', 'PatientPK': 'Patient#9452372230', 'Version': Decimal('1'), 'Resource': '{"resourceType": "Immunization", "status": "completed", "protocolApplied": [{"targetDisease": [{"coding": [{"system": "http://snomed.info/sct", "code": "240532009", "display": "Human papilloma virus infection"}]}], "doseNumberPositiveInt": 1}], "reasonCode": [{"coding": [{"system": "http://snomed.info/sct", "code": "443684005"}]}], "recorded": "2026-02-12", "identifier": [{"value": "OldNHSNo-20260212T161521", "system": "https://fhir.nhs.uk/Id/Automation-vaccine-administered-event-uk"}], "patient": {"reference": "#Patient1"}, "contained": [{"id": "Patient1", "resourceType": "Patient", "birthDate": "1980-11-01", "gender": "unknown", "address": [{"postalCode": "LS01 1AB"}], "identifier": [{"system": "https://fhir.nhs.uk/Id/nhs-number", "value": "9452372230"}], "name": [{"family": "test1", "given": ["test2"]}]}, {"resourceType": "Practitioner", "id": "Practitioner1", "name": [{"family": "Tests", "given": ["Automation"]}]}], "vaccineCode": {"coding": [{"system": "http://snomed.info/sct", "code": "33493111000001108", "display": "Gardasil 9 vaccine suspension for injection 0.5ml pre-filled syringes (Merck Sharp & Dohme (UK) Ltd) (product)"}]}, "manufacturer": {"display": "Merck Sharp & Dohme (UK) Ltd"}, "expirationDate": "2026-02-12", "lotNumber": "335463", "extension": [{"url": "https://fhir.hl7.org.uk/StructureDefinition/Extension-UKCore-VaccinationProcedure", "valueCodeableConcept": {"coding": [{"system": "http://snomed.info/sct", "code": "761841000", "display": "Administration of vaccine product containing only Human papillomavirus antigen (procedure)"}]}}], "occurrenceDateTime": "2026-02-12T16:14:31+00:00", "primarySource": true, "site": {"coding": [{"system": "http://snomed.info/sct", "code": "368208006", "display": "Left upper arm structure"}]}, "route": {"coding": [{"system": "http://snomed.info/sct", "code": "34206005", "display": "Subcutaneous route (qualifier value)"}]}, "doseQuantity": {"value": 0.5, "unit": "millilitre", "system": "http://snomed.info/sct", "code": "ml"}, "performer": [{"actor": {"type": "Organization", "identifier": {"system": "https://fhir.nhs.uk/Id/ods-organization-code", "value": "X99999"}}}, {"actor": {"reference": "#Practitioner1"}}], "location": {"identifier": {"value": "X99999", "system": "https://fhir.nhs.uk/Id/ods-organization-code"}}, "id": "800be473-9a1a-4dbd-9fb6-3381d17c5e9b"}', 'IdentifierPK': 'https://fhir.nhs.uk/Id/Automation-vaccine-administered-event-uk#OldNHSNo-20260212T161521'}], 'Count': 1, 'ScannedCount': 1, 'ResponseMetadata': {'RequestId': '9M4F1D6OHI8KCF4DNCHFAI1I6FVV4KQNSO5AEMVJF66Q9ASUAAJG', 'HTTPStatusCode': 200, 'HTTPHeaders': {'server': 'Server', 'date': 'Thu, 12 Feb 2026 16:16:11 GMT', 'content-type': 'application/x-amz-json-1.0', 'content-length': '3032', 'connection': 'keep-alive', 'x-amzn-requestid': '9M4F1D6OHI8KCF4DNCHFAI1I6FVV4KQNSO5AEMVJF66Q9ASUAAJG', 'x-amz-crc32': '3270910726'}, 'RetryAttempts': 0}} 

Attempt 1: Found 1 items

Found Immunization Delta items for ImmsID=1f900386-5f4f-4984-825f-4943220146fc

Attempt 1: Found 1 items

Found Immunization Delta items for ImmsID=3445b9d5-bcc4-44a3-b3bd-1408c0e65f48

Attempt 1: Found 1 items

Found Immunization Delta items for ImmsID=3d9a6a73-f9ec-4b2e-93c2-e250e1d29489

Attempt 1: Found 1 items

Found Immunization Delta items for ImmsID=800be473-9a1a-4dbd-9fb6-3381d17c5e9b

Attempt 1: Found 1 items

Found Immunization Delta items for ImmsID=c4db7f0f-5770-4936-8d2f-71dc09b32553

Sending DELETE request to: https://internal-qa.api.service.nhs.uk/immunisation-fhir-api/FHIR/R4/Immunization/c4db7f0f-5770-4936-8d2f-71dc09b32553
Sending DELETE request to: https://internal-qa.api.service.nhs.uk/immunisation-fhir-api/FHIR/R4/Immunization/3d9a6a73-f9ec-4b2e-93c2-e250e1d29489
Sending DELETE request to: https://internal-qa.api.service.nhs.uk/immunisation-fhir-api/FHIR/R4/Immunization/1f900386-5f4f-4984-825f-4943220146fc
Sending DELETE request to: https://internal-qa.api.service.nhs.uk/immunisation-fhir-api/FHIR/R4/Immunization/3445b9d5-bcc4-44a3-b3bd-1408c0e65f48
Sending DELETE request to: https://internal-qa.api.service.nhs.uk/immunisation-fhir-api/FHIR/R4/Immunization/800be473-9a1a-4dbd-9fb6-3381d17c5e9b
All IMMS_IDs deleted successfully.
