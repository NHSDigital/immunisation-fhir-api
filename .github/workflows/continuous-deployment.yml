name: Continuous Deployment Pipeline

on:
  push:
    branches:
      - master

jobs:
  deploy-internal-dev:
    uses: ./.github/workflows/deploy-backend.yml
    with:
      apigee_environment: internal-dev
      create_mns_subscription: true
      environment: dev
      sub_environment: internal-dev
    secrets:
      APIGEE_PASSWORD: ${{ secrets.APIGEE_PASSWORD }}
      APIGEE_BASIC_AUTH_TOKEN: ${{ secrets.APIGEE_BASIC_AUTH_TOKEN }}
      APIGEE_OTP_KEY: ${{ secrets.APIGEE_OTP_KEY }}
      STATUS_API_KEY: ${{ secrets.STATUS_API_KEY }}

  deploy-internal-dev-sandbox:
    uses: ./.github/workflows/deploy-backend.yml
    with:
      apigee_environment: internal-dev-sandbox
      environment: dev
      sub_environment: internal-dev-sandbox
    secrets:
      APIGEE_PASSWORD: ${{ secrets.APIGEE_PASSWORD }}
      APIGEE_BASIC_AUTH_TOKEN: ${{ secrets.APIGEE_BASIC_AUTH_TOKEN }}
      APIGEE_OTP_KEY: ${{ secrets.APIGEE_OTP_KEY }}
      STATUS_API_KEY: ${{ secrets.STATUS_API_KEY }}

  deploy-sandbox:
    needs: [deploy-internal-dev-sandbox]
    uses: ./.github/workflows/deploy-backend.yml
    with:
      apigee_environment: sandbox
      environment: dev
      sub_environment: sandbox
    secrets:
      APIGEE_PASSWORD: ${{ secrets.APIGEE_PASSWORD }}
      APIGEE_BASIC_AUTH_TOKEN: ${{ secrets.APIGEE_BASIC_AUTH_TOKEN }}
      APIGEE_OTP_KEY: ${{ secrets.APIGEE_OTP_KEY }}
      STATUS_API_KEY: ${{ secrets.STATUS_API_KEY }}

  deploy-higher-dev-envs:
    needs: [deploy-internal-dev]
    strategy:
      matrix:
        sub_environment_name: [ref, int]
    uses: ./.github/workflows/deploy-backend.yml
    with:
      apigee_environment: ${{ matrix.sub_environment_name }}
      create_mns_subscription: true
      environment: dev
      sub_environment: ${{ matrix.sub_environment_name }}
    secrets:
      APIGEE_PASSWORD: ${{ secrets.APIGEE_PASSWORD }}
      APIGEE_BASIC_AUTH_TOKEN: ${{ secrets.APIGEE_BASIC_AUTH_TOKEN }}
      APIGEE_OTP_KEY: ${{ secrets.APIGEE_OTP_KEY }}
      STATUS_API_KEY: ${{ secrets.STATUS_API_KEY }}
