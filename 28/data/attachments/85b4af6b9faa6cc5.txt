✅ Pipe-delimited file saved to: /home/runner/work/immunisation-fhir-api/immunisation-fhir-api/tests/e2e_automation/batch_files_directory/MENACWY_Vaccinations_v5_YGA_20260206T17091300.csv
Batch file created: MENACWY_Vaccinations_v5_YGA_20260206T17091300.csv
Upload successful: MENACWY_Vaccinations_v5_YGA_20260206T17091300.csv → immunisation-batch-pr-1168-data-sources
Batch file uploaded to S3: MENACWY_Vaccinations_v5_YGA_20260206T17091300.csv
Waiting for file in archive: s3://immunisation-batch-pr-1168-data-sources/archive/MENACWY_Vaccinations_v5_YGA_20260206T17091300.csv
Still waiting... (0s)
Still waiting... (5s)
Still waiting... (10s)
Still waiting... (15s)
Still waiting... (20s)
Still waiting... (25s)
Still waiting... (30s)
Still waiting... (35s)
File found in archive: archive/MENACWY_Vaccinations_v5_YGA_20260206T17091300.csv
Waiting for ACK files starting with 'ack/MENACWY_Vaccinations_v5_YGA_20260206T17091300' in bucket: immunisation-batch-pr-1168-data-destinations
[MODE] Expecting ONLY CSV ACK file
[FOUND] .csv file located: ack/MENACWY_Vaccinations_v5_YGA_20260206T17091300_InfAck_20260206T17091400.csv
[SUCCESS] Loaded .csv file (299 bytes)
[COMPLETE] All expected ACK files received
Waiting for ACK files starting with 'forwardedFile/MENACWY_Vaccinations_v5_YGA_20260206T17091300' in bucket: immunisation-batch-pr-1168-data-destinations
[MODE] Expecting BOTH CSV and JSON ACK files
[FOUND] .csv file located: forwardedFile/MENACWY_Vaccinations_v5_YGA_20260206T17091300_BusAck_20260206T17091400.csv
[SUCCESS] Loaded .csv file (208 bytes)
[FOUND] .json file located: forwardedFile/MENACWY_Vaccinations_v5_YGA_20260206T17091300_BusAck_20260206T17091400.json
[SUCCESS] Loaded .json file (436 bytes)
[COMPLETE] All expected ACK files received
No rows found in BUS ACK file for successful records
Attempt 1: Found 1 items

Found Audit detail for filename=MENACWY_Vaccinations_v5_YGA_20260206T17091300.csv


 Imms Event response is {'Items': [{'Version': Decimal('1'), 'Operation': 'CREATE', 'IdentifierPK': 'https://fhir.nhs.uk/Id/Automation-vaccine-administered-event-uk#Action_flag_NEW-20260206T170913', 'PatientPK': 'Patient#9461450729', 'PK': 'Immunization#0116531b-687a-41a2-8512-bf189db41833', 'SupplierSystem': 'TPP', 'Resource': '{"resourceType": "Immunization", "status": "completed", "protocolApplied": [{"targetDisease": [{"coding": [{"system": "http://snomed.info/sct", "code": "23511006", "display": "Meningococcal infectious disease"}]}], "doseNumberPositiveInt": 1}], "reasonCode": [{"coding": [{"system": "http://snomed.info/sct", "code": "443684005"}]}], "recorded": "2026-02-06", "identifier": [{"value": "Action_flag_NEW-20260206T170913", "system": "https://fhir.nhs.uk/Id/Automation-vaccine-administered-event-uk"}], "patient": {"reference": "#Patient1"}, "contained": [{"id": "Patient1", "resourceType": "Patient", "birthDate": "2009-09-23", "gender": "female", "address": [{"postalCode": "DL8 2QB"}], "identifier": [{"system": "https://fhir.nhs.uk/Id/nhs-number", "value": "9461450729"}], "name": [{"family": "MYRTIE", "given": ["WARDHAUGH"]}]}, {"resourceType": "Practitioner", "id": "Practitioner1", "name": [{"family": "Tests", "given": ["Automation"]}]}], "vaccineCode": {"coding": [{"system": "http://snomed.info/sct", "code": "20517811000001104", "display": "Nimenrix vaccine powder and solvent for solution for injection 0.5ml pre-filled syringes (GlaxoSmithKline UK Ltd) (product)"}]}, "manufacturer": {"display": "GlaxoSmithKline UK Ltd"}, "expirationDate": "2026-02-06", "lotNumber": "164523", "extension": [{"url": "https://fhir.hl7.org.uk/StructureDefinition/Extension-UKCore-VaccinationProcedure", "valueCodeableConcept": {"coding": [{"system": "http://snomed.info/sct", "code": "871874000", "display": "Administration of vaccine product containing only Neisseria meningitidis serogroup A, C, W135 and Y antigens (procedure)"}]}}], "occurrenceDateTime": "2026-02-06T17:08:23+00:00", "primarySource": true, "site": {"coding": [{"system": "http://snomed.info/sct", "code": "368208006", "display": "Left upper arm structure"}]}, "route": {"coding": [{"system": "http://snomed.info/sct", "code": "78421000", "display": "Intramuscular"}]}, "doseQuantity": {"value": 0.5, "unit": "millilitre", "system": "http://snomed.info/sct", "code": "ml"}, "performer": [{"actor": {"type": "Organization", "identifier": {"system": "https://fhir.nhs.uk/Id/ods-organization-code", "value": "X99999"}}}, {"actor": {"reference": "#Practitioner1"}}], "location": {"identifier": {"value": "X99999", "system": "https://fhir.nhs.uk/Id/ods-organization-code"}}, "id": "0116531b-687a-41a2-8512-bf189db41833"}', 'PatientSK': 'MENACWY#0116531b-687a-41a2-8512-bf189db41833'}], 'Count': 1, 'ScannedCount': 1, 'ResponseMetadata': {'RequestId': '8QK654IB8Q8JSSVVAMSV53V303VV4KQNSO5AEMVJF66Q9ASUAAJG', 'HTTPStatusCode': 200, 'HTTPHeaders': {'server': 'Server', 'date': 'Fri, 06 Feb 2026 17:09:56 GMT', 'content-type': 'application/x-amz-json-1.0', 'content-length': '3067', 'connection': 'keep-alive', 'x-amzn-requestid': '8QK654IB8Q8JSSVVAMSV53V303VV4KQNSO5AEMVJF66Q9ASUAAJG', 'x-amz-crc32': '1110794847'}, 'RetryAttempts': 0}} 


 Imms Event response is {'Items': [{'IdentifierPK': 'https://fhir.nhs.uk/Id/Automation-vaccine-administered-event-uk#Action_flag_New-20260206T170913', 'PatientPK': 'Patient#9000171229', 'Version': Decimal('1'), 'PatientSK': 'MENACWY#0a022f9c-e73f-417c-b82b-e4cc10449fdd', 'PK': 'Immunization#0a022f9c-e73f-417c-b82b-e4cc10449fdd', 'Operation': 'CREATE', 'Resource': '{"resourceType": "Immunization", "status": "completed", "protocolApplied": [{"targetDisease": [{"coding": [{"system": "http://snomed.info/sct", "code": "23511006", "display": "Meningococcal infectious disease"}]}], "doseNumberPositiveInt": 1}], "reasonCode": [{"coding": [{"system": "http://snomed.info/sct", "code": "443684005"}]}], "recorded": "2026-02-06", "identifier": [{"value": "Action_flag_New-20260206T170913", "system": "https://fhir.nhs.uk/Id/Automation-vaccine-administered-event-uk"}], "patient": {"reference": "#Patient1"}, "contained": [{"id": "Patient1", "resourceType": "Patient", "birthDate": "2003-01-04", "gender": "female", "address": [{"postalCode": "N8 7RE"}], "identifier": [{"system": "https://fhir.nhs.uk/Id/nhs-number", "value": "9000171229"}], "name": [{"family": "ROGELIO", "given": ["MANTE"]}]}, {"resourceType": "Practitioner", "id": "Practitioner1", "name": [{"family": "Tests", "given": ["Automation"]}]}], "vaccineCode": {"coding": [{"system": "http://snomed.info/sct", "code": "17188711000001105", "display": "Menveo vaccine powder and solvent for solution for injection 0.5ml vials (Novartis Vaccines and Diagnostics Ltd) (product)"}]}, "manufacturer": {"display": "Novartis Vaccines and Diagnostics Ltd"}, "expirationDate": "2026-02-06", "lotNumber": "941620", "extension": [{"url": "https://fhir.hl7.org.uk/StructureDefinition/Extension-UKCore-VaccinationProcedure", "valueCodeableConcept": {"coding": [{"system": "http://snomed.info/sct", "code": "871874000", "display": "Administration of vaccine product containing only Neisseria meningitidis serogroup A, C, W135 and Y antigens (procedure)"}]}}], "occurrenceDateTime": "2026-02-06T17:08:23+00:00", "primarySource": true, "site": {"coding": [{"system": "http://snomed.info/sct", "code": "368208006", "display": "Left upper arm structure"}]}, "route": {"coding": [{"system": "http://snomed.info/sct", "code": "78421000", "display": "Intramuscular"}]}, "doseQuantity": {"value": 0.5, "unit": "millilitre", "system": "http://snomed.info/sct", "code": "ml"}, "performer": [{"actor": {"type": "Organization", "identifier": {"system": "https://fhir.nhs.uk/Id/ods-organization-code", "value": "X99999"}}}, {"actor": {"reference": "#Practitioner1"}}], "location": {"identifier": {"value": "X99999", "system": "https://fhir.nhs.uk/Id/ods-organization-code"}}, "id": "0a022f9c-e73f-417c-b82b-e4cc10449fdd"}', 'SupplierSystem': 'TPP'}], 'Count': 1, 'ScannedCount': 1, 'ResponseMetadata': {'RequestId': 'OQG68DGRBT8SUBQSPUAJ6HIEJRVV4KQNSO5AEMVJF66Q9ASUAAJG', 'HTTPStatusCode': 200, 'HTTPHeaders': {'server': 'Server', 'date': 'Fri, 06 Feb 2026 17:09:56 GMT', 'content-type': 'application/x-amz-json-1.0', 'content-length': '3077', 'connection': 'keep-alive', 'x-amzn-requestid': 'OQG68DGRBT8SUBQSPUAJ6HIEJRVV4KQNSO5AEMVJF66Q9ASUAAJG', 'x-amz-crc32': '2637440324'}, 'RetryAttempts': 0}} 


 Imms Event response is {'Items': [{'Operation': 'CREATE', 'Version': Decimal('1'), 'SupplierSystem': 'TPP', 'Resource': '{"resourceType": "Immunization", "status": "completed", "protocolApplied": [{"targetDisease": [{"coding": [{"system": "http://snomed.info/sct", "code": "23511006", "display": "Meningococcal infectious disease"}]}], "doseNumberPositiveInt": 1}], "reasonCode": [{"coding": [{"system": "http://snomed.info/sct", "code": "443684005"}]}], "recorded": "2026-02-06", "identifier": [{"value": "Action_flag_new-20260206T170913", "system": "https://fhir.nhs.uk/Id/Automation-vaccine-administered-event-uk"}], "patient": {"reference": "#Patient1"}, "contained": [{"id": "Patient1", "resourceType": "Patient", "birthDate": "2008-03-25", "gender": "female", "address": [{"postalCode": "N8 7RE"}], "identifier": [{"system": "https://fhir.nhs.uk/Id/nhs-number", "value": "9000177138"}], "name": [{"family": "SKYE", "given": ["KIHN"]}]}, {"resourceType": "Practitioner", "id": "Practitioner1", "name": [{"family": "Tests", "given": ["Automation"]}]}], "vaccineCode": {"coding": [{"system": "http://snomed.info/sct", "code": "20517811000001104", "display": "Nimenrix vaccine powder and solvent for solution for injection 0.5ml pre-filled syringes (GlaxoSmithKline UK Ltd) (product)"}]}, "manufacturer": {"display": "GlaxoSmithKline UK Ltd"}, "expirationDate": "2026-02-06", "lotNumber": "662377", "extension": [{"url": "https://fhir.hl7.org.uk/StructureDefinition/Extension-UKCore-VaccinationProcedure", "valueCodeableConcept": {"coding": [{"system": "http://snomed.info/sct", "code": "871874000", "display": "Administration of vaccine product containing only Neisseria meningitidis serogroup A, C, W135 and Y antigens (procedure)"}]}}], "occurrenceDateTime": "2026-02-06T17:08:23+00:00", "primarySource": true, "site": {"coding": [{"system": "http://snomed.info/sct", "code": "368209003", "display": "Right upper arm structure"}]}, "route": {"coding": [{"system": "http://snomed.info/sct", "code": "78421000", "display": "Intramuscular"}]}, "doseQuantity": {"value": 0.5, "unit": "millilitre", "system": "http://snomed.info/sct", "code": "ml"}, "performer": [{"actor": {"type": "Organization", "identifier": {"system": "https://fhir.nhs.uk/Id/ods-organization-code", "value": "X99999"}}}, {"actor": {"reference": "#Practitioner1"}}], "location": {"identifier": {"value": "X99999", "system": "https://fhir.nhs.uk/Id/ods-organization-code"}}, "id": "9471b530-6fd7-44ac-aada-2aa91a79a988"}', 'IdentifierPK': 'https://fhir.nhs.uk/Id/Automation-vaccine-administered-event-uk#Action_flag_new-20260206T170913', 'PatientPK': 'Patient#9000177138', 'PatientSK': 'MENACWY#9471b530-6fd7-44ac-aada-2aa91a79a988', 'PK': 'Immunization#9471b530-6fd7-44ac-aada-2aa91a79a988'}], 'Count': 1, 'ScannedCount': 1, 'ResponseMetadata': {'RequestId': 'TS3B7JNRV6FC7EKNL3THEUNTNJVV4KQNSO5AEMVJF66Q9ASUAAJG', 'HTTPStatusCode': 200, 'HTTPHeaders': {'server': 'Server', 'date': 'Fri, 06 Feb 2026 17:09:57 GMT', 'content-type': 'application/x-amz-json-1.0', 'content-length': '3060', 'connection': 'keep-alive', 'x-amzn-requestid': 'TS3B7JNRV6FC7EKNL3THEUNTNJVV4KQNSO5AEMVJF66Q9ASUAAJG', 'x-amz-crc32': '210070958'}, 'RetryAttempts': 0}} 


 Imms Event response is {'Items': [{'Version': Decimal('1'), 'PatientPK': 'Patient#9459995535', 'IdentifierPK': 'https://fhir.nhs.uk/Id/Automation-vaccine-administered-event-uk#Action_flag_nEw-20260206T170913', 'PatientSK': 'MENACWY#523ac2b9-fecf-4b96-897a-9451e195d6a6', 'SupplierSystem': 'TPP', 'PK': 'Immunization#523ac2b9-fecf-4b96-897a-9451e195d6a6', 'Operation': 'CREATE', 'Resource': '{"resourceType": "Immunization", "status": "completed", "protocolApplied": [{"targetDisease": [{"coding": [{"system": "http://snomed.info/sct", "code": "23511006", "display": "Meningococcal infectious disease"}]}], "doseNumberPositiveInt": 1}], "reasonCode": [{"coding": [{"system": "http://snomed.info/sct", "code": "443684005"}]}], "recorded": "2026-02-06", "identifier": [{"value": "Action_flag_nEw-20260206T170913", "system": "https://fhir.nhs.uk/Id/Automation-vaccine-administered-event-uk"}], "patient": {"reference": "#Patient1"}, "contained": [{"id": "Patient1", "resourceType": "Patient", "birthDate": "2002-03-13", "gender": "unknown", "address": [{"postalCode": "BD20 8PW"}], "identifier": [{"system": "https://fhir.nhs.uk/Id/nhs-number", "value": "9459995535"}], "name": [{"family": "NORMAND", "given": ["SONGU"]}]}, {"resourceType": "Practitioner", "id": "Practitioner1", "name": [{"family": "Tests", "given": ["Automation"]}]}], "vaccineCode": {"coding": [{"system": "http://snomed.info/sct", "code": "17188711000001105", "display": "Menveo vaccine powder and solvent for solution for injection 0.5ml vials (Novartis Vaccines and Diagnostics Ltd) (product)"}]}, "manufacturer": {"display": "Novartis Vaccines and Diagnostics Ltd"}, "expirationDate": "2026-02-06", "lotNumber": "392879", "extension": [{"url": "https://fhir.hl7.org.uk/StructureDefinition/Extension-UKCore-VaccinationProcedure", "valueCodeableConcept": {"coding": [{"system": "http://snomed.info/sct", "code": "871874000", "display": "Administration of vaccine product containing only Neisseria meningitidis serogroup A, C, W135 and Y antigens (procedure)"}]}}], "occurrenceDateTime": "2026-02-06T17:08:23+00:00", "primarySource": true, "site": {"coding": [{"system": "http://snomed.info/sct", "code": "368209003", "display": "Right upper arm structure"}]}, "route": {"coding": [{"system": "http://snomed.info/sct", "code": "78421000", "display": "Intramuscular"}]}, "doseQuantity": {"value": 0.5, "unit": "millilitre", "system": "http://snomed.info/sct", "code": "ml"}, "performer": [{"actor": {"type": "Organization", "identifier": {"system": "https://fhir.nhs.uk/Id/ods-organization-code", "value": "X99999"}}}, {"actor": {"reference": "#Practitioner1"}}], "location": {"identifier": {"value": "X99999", "system": "https://fhir.nhs.uk/Id/ods-organization-code"}}, "id": "523ac2b9-fecf-4b96-897a-9451e195d6a6"}'}], 'Count': 1, 'ScannedCount': 1, 'ResponseMetadata': {'RequestId': 'B60PRSCECG1G6UO1N7GO33EGAFVV4KQNSO5AEMVJF66Q9ASUAAJG', 'HTTPStatusCode': 200, 'HTTPHeaders': {'server': 'Server', 'date': 'Fri, 06 Feb 2026 17:09:57 GMT', 'content-type': 'application/x-amz-json-1.0', 'content-length': '3081', 'connection': 'keep-alive', 'x-amzn-requestid': 'B60PRSCECG1G6UO1N7GO33EGAFVV4KQNSO5AEMVJF66Q9ASUAAJG', 'x-amz-crc32': '4273206420'}, 'RetryAttempts': 0}} 

Attempt 1: Found 1 items

Found Immunization Delta items for ImmsID=0116531b-687a-41a2-8512-bf189db41833

Attempt 1: Found 1 items

Found Immunization Delta items for ImmsID=0a022f9c-e73f-417c-b82b-e4cc10449fdd

Attempt 1: Found 0 items
Attempt 2: Found 0 items
Attempt 3: Found 0 items
Attempt 4: Found 0 items
Attempt 5: Found 1 items

Found Immunization Delta items for ImmsID=523ac2b9-fecf-4b96-897a-9451e195d6a6

Attempt 1: Found 1 items

Found Immunization Delta items for ImmsID=9471b530-6fd7-44ac-aada-2aa91a79a988

Sending DELETE request to: https://internal-dev.api.service.nhs.uk/immunisation-fhir-api/FHIR/R4-pr-1168/Immunization/0116531b-687a-41a2-8512-bf189db41833
Sending DELETE request to: https://internal-dev.api.service.nhs.uk/immunisation-fhir-api/FHIR/R4-pr-1168/Immunization/0a022f9c-e73f-417c-b82b-e4cc10449fdd
Sending DELETE request to: https://internal-dev.api.service.nhs.uk/immunisation-fhir-api/FHIR/R4-pr-1168/Immunization/9471b530-6fd7-44ac-aada-2aa91a79a988
Sending DELETE request to: https://internal-dev.api.service.nhs.uk/immunisation-fhir-api/FHIR/R4-pr-1168/Immunization/523ac2b9-fecf-4b96-897a-9451e195d6a6
All IMMS_IDs deleted successfully.
